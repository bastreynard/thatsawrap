# Development Dockerfile - Single Container with Hot Reload
FROM node:18-alpine

WORKDIR /app

# Install Python, pip, nginx, and supervisor
RUN apk add --no-cache \
    python3 \
    py3-pip \
    nginx \
    supervisor \
    bash

# Copy and install Python requirements
COPY requirements.txt ./
RUN pip3 install --no-cache-dir --break-system-packages -r requirements.txt

# Copy backend code (will be overridden by volume mount)
COPY backend.py ./

# Copy frontend for initial npm install
COPY thatsawrap-react/package*.json /app/frontend/
WORKDIR /app/frontend
RUN npm install

# Create nginx config for development
RUN mkdir -p /run/nginx && \
    cat > /etc/nginx/nginx.conf << 'NGINXEOF'
user root;
worker_processes 1;
error_log /dev/stderr warn;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    access_log /dev/stdout;
    sendfile on;
    keepalive_timeout 65;

    server {
        listen 8080;
        
        # Proxy API calls to Flask backend
        location /api/ {
            rewrite ^/api/(.*) /$1 break;
            proxy_pass http://127.0.0.1:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Proxy everything else to React dev server
        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_set_header Host $host;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
NGINXEOF

# Create supervisor config
RUN mkdir -p /var/log/supervisor && \
    cat > /etc/supervisord.conf << 'SUPERVISOREOF'
[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/tmp/supervisord.pid

[program:flask]
command=python3 -m flask run --host=0.0.0.0 --port=5000 --reload
directory=/app
environment=FLASK_APP=backend.py,FLASK_ENV=development,FLASK_DEBUG=1
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:react]
command=npm start
directory=/app/frontend
environment=BROWSER=none,CHOKIDAR_USEPOLLING=true,WDS_SOCKET_PORT=0
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
SUPERVISOREOF

WORKDIR /app

EXPOSE 8080

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf"]